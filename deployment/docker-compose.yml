version: "3.8"

services:
  # ---------------------------
  # 1. Edge Layer (Ingress)
  # ---------------------------
  caddy:
    image: caddy:2
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - hive-net

  # ---------------------------
  # 2. Infrastructure Layer
  # ---------------------------
  
  # Message Bus
  nostr-relay:
    image: scsibug/nostr-rs-relay:latest
    restart: always
    user: root
    volumes:
      - ./relay_data:/usr/src/app/db
      - ./config.toml:/usr/src/app/config.toml
    networks:
      - hive-net

  # [NEW] Agent API Platform (The Infrastructure Controller)
  agent-api:
    build: 
      context: ..
      dockerfile: nanobot/agent_platform/Dockerfile
    restart: always
    environment:
      - API_KEY=${AGENT_API_KEY:-sk-hive-prod-37b3f580730685be6e7c667e4c027c6e}
      - DOCKER_NETWORK=deployment_hive-net
      - AGENT_IMAGE=deployment-sol
      - NOSTR_RELAY_URL=ws://nostr-relay:8080
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./agents.db:/app/agents.db
    networks:
      - hive-net

networks:
  hive-net:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
